<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudCore - Create Account</title>
    <link rel="stylesheet" href="css/auth.css">
    <link rel="icon" href="data:,">
</head>
<body>
<div class="register-container">
    <div class="language-switcher">
        <button class="language-btn" id="languageBtn" onclick="switchLanguage()" title="Switch language">
            <span class="language-flag" id="langFlag">üåê</span>
            <span class="language-code" id="langCode">EN</span>
        </button>
    </div>
    <h1>‚òÅÔ∏è CloudCore</h1>

    <div id="error-message" class="error" style="display: none;"></div>
    <div id="success-message" class="success" style="display: none;"></div>

    <form class="register-form" id="registerForm">
        <div class="form-group">
            <label for="username" data-i18n="username">Username</label>
            <input type="text" id="username" name="username" required
                   minlength="3" maxlength="50"
                   pattern="[a-zA-Z0-9_]+"
                   title="Only letters, numbers, and underscores allowed">
        </div>

        <div class="form-group">
            <label for="email" data-i18n="emailAddress">Email Address</label>
            <input type="email" id="email" name="email" required
                   maxlength="100">
        </div>

        <div class="form-group">
            <label for="password" data-i18n="password">Password</label>
            <input type="password" id="password" name="password" required
                   minlength="6"
                   title="Password must be at least 6 characters long">
        </div>

        <div class="form-group">
            <label for="confirmPassword" data-i18n="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required>
        </div>

        <button type="submit" class="btn btn-primary" id="registerBtn" data-i18n="createAccount">Create Account</button>
    </form>

    <div class="login-link"><span data-i18n="alreadyAccount">Already have an account?</span> <a href="login.html" data-i18n="signIn">Sign in</a>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:5000';
    let currentLanguage = localStorage.getItem('cloudcore-language') || 'en';

    // Translation object - following the same structure as main CloudCore system
    const translations = {
        en: {
            title: 'CloudCore - Create Account',
            username: 'Username',
            emailAddress: 'Email Address',
            password: 'Password',
            confirmPassword: 'Confirm Password',
            createAccount: 'Create Account',
            creatingAccount: 'Creating account...',
            alreadyAccount: 'Already have an account?',
            signIn: 'Sign in',
            accountCreated: 'Account created successfully! Welcome, {username}!',
            registrationFailed: 'Registration failed. Please try again.',
            connectionError: 'Unable to connect to server. Please try again.',
            registrationSuccessful: 'üéâ Registration successful!',
            passwordsNoMatch: 'Passwords do not match',
            invalidCredentials: 'Invalid registration data',
            usernameTooltip: 'Only letters, numbers, and underscores allowed',
            emailTooltip: 'Please enter a valid email address', 
            passwordTooltip: 'Password must be at least 6 characters long',
            confirmPasswordTooltip: 'Please confirm your password'
        },
        uk: {
            title: 'CloudCore - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É',
            username: '–Ü–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞',
            emailAddress: '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –∞–¥—Ä–µ—Å–∞',
            password: '–ü–∞—Ä–æ–ª—å',
            confirmPassword: '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–∞—Ä–æ–ª—å',
            createAccount: '–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å',
            creatingAccount: '–°—Ç–≤–æ—Ä—é—é –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å...',
            alreadyAccount: '–í–∂–µ –º–∞—î—Ç–µ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å?',
            signIn: '–£–≤—ñ–π—Ç–∏',
            accountCreated: '–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ! –í—ñ—Ç–∞—î–º–æ, {username}!',
            registrationFailed: '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.',
            connectionError: '–ù–µ–º–æ–∂–ª–∏–≤–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.',
            registrationSuccessful: 'üéâ –£—Å–ø—ñ—à–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è!',
            passwordsNoMatch: '–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è',
            invalidCredentials: '–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó',
            usernameTooltip: '–î–æ–∑–≤–æ–ª–µ–Ω—ñ –ª–∏—à–µ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è',
            emailTooltip: '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –∞–¥—Ä–µ—Å—É',
            passwordTooltip: '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤', 
            confirmPasswordTooltip: '–ë—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å —Å–≤—ñ–π –ø–∞—Ä–æ–ª—å'
        }
    };

    // Translation helper function - same as main system
    function t(key) {
        return translations[currentLanguage][key] || key;
    }

    // Language switching function - exactly like in main system
    function switchLanguage() {
        currentLanguage = currentLanguage === 'en' ? 'uk' : 'en';
        localStorage.setItem('cloudcore-language', currentLanguage);
        updateLanguageButton();
        updateUILanguage();
    }

    // Update language button display - same as main system
    function updateLanguageButton() {
        const btn = document.getElementById('languageBtn');
        const flag = btn.querySelector('.language-flag');
        const code = btn.querySelector('.language-code');
        
        if (currentLanguage === 'uk') {
            flag.textContent = 'üá∫üá¶';
            code.textContent = 'UA';
            btn.title = '–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –º–æ–≤—É';
        } else {
            flag.textContent = 'üåê';
            code.textContent = 'EN';
            btn.title = 'Switch language';
        }
    }

    // Update UI language - using data-i18n pattern like main system
    function updateUILanguage() {
        document.title = t('title');
        
        // Update all elements with data-i18n attributes
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[currentLanguage][key]) {
                element.textContent = translations[currentLanguage][key];
            }
        });

        document.getElementById('username').title = t('usernameTooltip');
        document.getElementById('email').title = t('emailTooltip'); 
        document.getElementById('password').title = t('passwordTooltip');
        document.getElementById('confirmPassword').title = t('confirmPasswordTooltip');
    }
    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('success-message').style.display = 'none';
    }

    // Show success message
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('error-message').style.display = 'none';
    }

    // Hide all messages
    function hideMessages() {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
    }

    // Validate password confirmation
    function validatePasswords() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password !== confirmPassword) {
            showError(t('passwordsNoMatch'));
            return false;
        }

        return true;
    }

    // Handle registration form submission
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validatePasswords()) {
            return;
        }

        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const registerBtn = document.getElementById('registerBtn');

        // Disable button and show loading
        registerBtn.disabled = true;
        registerBtn.textContent = t('creatingAccount');
        hideMessages();

        try {
            const response = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    email: email,
                    password: password
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Success! Store token and redirect
                localStorage.setItem('cloudcore_token', data.token);
                localStorage.setItem('cloudcore_user', JSON.stringify({
                    id: data.userId,
                    username: data.username,
                    email: data.email
                }));

                console.log('üéâ Registration successful!');
                console.log('JWT Token:', data.token);
                console.log('User Info:', data);

                showSuccess(t('accountCreated').replace('{username}', data.username));

                // Redirect to main page after 2 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } else {
                // Registration failed
                let errorMessage = t('registrationFailed'); // default message
                
                if (data.message) {
                    errorMessage = data.message; // Use server message if available
                }
                
                showError(errorMessage);
            }

        } catch (error) {
            console.error('Registration error:', error);
            showError(t('connectionError'));
        } finally {
            // Re-enable button
            registerBtn.disabled = false;
            registerBtn.textContent = t('createAccount');
        }
    });

    // Add real-time password confirmation validation
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;

        if (confirmPassword && password !== confirmPassword) {
            this.style.borderColor = '#d93025';
        } else {
            this.style.borderColor = '#dadce0';
        }
    });

    // Check if user is already logged in
    window.addEventListener('load', function() {
        const token = localStorage.getItem('cloudcore_token');
        if (token) {
            console.log('User already logged in, redirecting...');
            window.location.href = 'index.html';
        }

        updateLanguageButton();
        updateUILanguage();
    });
</script>
</body>
</html>
